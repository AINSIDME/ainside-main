<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AInside License Protector - TradeStation Strategies</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a7b 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #3dd5af 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.3em;
            color: #1e3a5f;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3dd5af;
        }
        
        textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #3dd5af;
        }
        
        .button-container {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            background: linear-gradient(135deg, #1e3a5f 0%, #3dd5af 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(61, 213, 175, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-copy {
            background: #28a745;
            padding: 10px 30px;
            font-size: 0.95em;
            margin-top: 10px;
        }
        
        .btn-copy:hover {
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        }
        
        .output {
            background: #f8f9fa;
            border: 2px solid #3dd5af;
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .feature-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3dd5af;
        }
        
        .feature-card h3 {
            color: #1e3a5f;
            margin-bottom: 10px;
        }
        
        .feature-card p {
            color: #666;
            line-height: 1.6;
        }
        
        .hidden {
            display: none;
        }
        
        pre {
            margin: 0;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #1e3a5f;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .protection-mode {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .radio-card {
            flex: 1;
            max-width: 300px;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .radio-card:hover {
            border-color: #3dd5af;
            background: #f8f9fa;
        }
        
        .radio-card input[type="radio"] {
            display: none;
        }
        
        .radio-card input[type="radio"]:checked + label {
            color: #1e3a5f;
            font-weight: bold;
        }
        
        .radio-card input[type="radio"]:checked ~ .card-body {
            border-left: 4px solid #3dd5af;
            padding-left: 15px;
        }
        
        .radio-card label {
            font-size: 1.1em;
            cursor: pointer;
            display: block;
            margin-bottom: 10px;
        }
        
        .card-body {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
            transition: all 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è AInside License Protector</h1>
            <p>Protege tus estrategias de TradeStation con licencias HWID</p>
        </div>
        
        <div class="content">
            <div class="alert alert-info">
                <strong>üìã Instrucciones:</strong> Pega tu estrategia de TradeStation en el campo de abajo, selecciona el modo de protecci√≥n y presiona "Proteger Estrategia".
            </div>
            
            <div class="features">
                <div class="feature-card">
                    <h3>‚úÖ Verificaci√≥n HWID</h3>
                    <p>Valida la licencia en cada barra usando el hardware ID √∫nico del PC</p>
                </div>
                <div class="feature-card">
                    <h3>üîí Cierre Autom√°tico</h3>
                    <p>Cierra posiciones inmediatamente si la licencia no es v√°lida</p>
                </div>
                <div class="feature-card">
                    <h3>üìä Modo Inteligente</h3>
                    <p>Protege solo las √≥rdenes, los c√°lculos se ejecutan siempre</p>
                </div>
                <div class="feature-card">
                    <h3>üöÄ Plug & Play</h3>
                    <p>Tu estrategia mantiene toda su l√≥gica original intacta</p>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">‚öôÔ∏è Modo de Protecci√≥n</div>
                <div class="protection-mode">
                    <div class="radio-card" onclick="document.getElementById('modeOrders').checked = true">
                        <input type="radio" name="mode" id="modeOrders" value="orders" checked>
                        <label for="modeOrders">üéØ Solo √ìrdenes (Recomendado)</label>
                        <div class="card-body">
                            Protege √∫nicamente las √≥rdenes de trading (Buy, Sell, etc). Los c√°lculos e indicadores se ejecutan siempre. La estrategia encuentra se√±ales pero no opera sin licencia.
                        </div>
                    </div>
                    <div class="radio-card" onclick="document.getElementById('modeFull').checked = true">
                        <input type="radio" name="mode" id="modeFull" value="full">
                        <label for="modeFull">üîê Todo el C√≥digo</label>
                        <div class="card-body">
                            Envuelve toda la l√≥gica de trading. Sin licencia, la estrategia no ejecuta ning√∫n c√≥digo (ni c√°lculos ni √≥rdenes). M√°xima seguridad.
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">1Ô∏è‚É£ Estrategia Original (sin protecci√≥n)</div>
                <textarea id="inputStrategy" placeholder="Pega aqu√≠ tu estrategia de TradeStation...

Ejemplo:

Inputs:
    FastLength(9),
    SlowLength(18);

Variables:
    FastMA(0),
    SlowMA(0);

FastMA = Average(Close, FastLength);
SlowMA = Average(Close, SlowLength);

if FastMA crosses above SlowMA then
    Buy(&quot;Long&quot;) next bar at market;
    
if FastMA crosses below SlowMA then
    Sell(&quot;Exit&quot;) next bar at market;
"></textarea>
            </div>
            
            <div class="button-container">
                <button class="btn" onclick="protectStrategy()">
                    üõ°Ô∏è PROTEGER CON LICENCIA AINSIDE
                </button>
            </div>
            
            <div class="section hidden" id="outputSection">
                <div class="section-title">2Ô∏è‚É£ Estrategia Protegida (lista para usar)</div>
                
                <div class="alert alert-success">
                    <strong>‚úÖ ¬°Estrategia protegida exitosamente!</strong> 
                    Copia el c√≥digo de abajo e imp√≥rtalo en TradeStation.
                </div>
                
                <div class="alert alert-warning hidden" id="warningBox">
                    <strong>‚ö†Ô∏è Advertencias:</strong>
                    <ul id="warningList" style="margin-left: 20px; margin-top: 10px;"></ul>
                </div>
                
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="originalLines">0</div>
                        <div class="stat-label">L√≠neas originales</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="protectedLines">0</div>
                        <div class="stat-label">L√≠neas protegidas</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="addedLines">0</div>
                        <div class="stat-label">L√≠neas agregadas</div>
                    </div>
                </div>
                
                <div class="output" id="outputStrategy"></div>
                
                <div class="button-container">
                    <button class="btn btn-copy" onclick="copyToClipboard(event)">
                        üìã COPIAR AL PORTAPAPELES
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function protectStrategy() {
            const inputElement = document.getElementById('inputStrategy');
            const input = inputElement ? inputElement.value.trim() : '';
            const modeElement = document.querySelector('input[name="mode"]:checked');
            const mode = modeElement ? modeElement.value : 'orders';
            
            console.log('Input length:', input.length); // Debug
            console.log('Mode:', mode); // Debug
            
            if (!input || input.length < 10) {
                alert('‚ö†Ô∏è Por favor pega tu estrategia primero');
                inputElement.focus();
                return;
            }
            
            // Detectar si ya tiene la protecci√≥n
            if (input.includes('DefineDLLFunc') || input.includes('AInside_IsAllowed')) {
                if (!confirm('‚ö†Ô∏è Esta estrategia ya parece tener protecci√≥n de licencia. ¬øDeseas reemplazarla?')) {
                    return;
                }
            }
            
            try {
                // Construir estrategia protegida
                const result = mode === 'orders' 
                    ? generateSmartProtection(input)
                    : generateFullProtection(input);
                
                // Mostrar resultado
                document.getElementById('outputStrategy').textContent = result.code;
                document.getElementById('outputSection').classList.remove('hidden');
                
                // Mostrar advertencias si las hay
                const warningBox = document.getElementById('warningBox');
                const warningList = document.getElementById('warningList');
                if (result.warnings && result.warnings.length > 0) {
                    warningList.innerHTML = result.warnings.map(w => `<li>${w}</li>`).join('');
                    warningBox.classList.remove('hidden');
                } else {
                    warningBox.classList.add('hidden');
                }
                
                // Calcular estad√≠sticas
                const originalLines = input.split('\n').length;
                const protectedLines = result.code.split('\n').length;
                const addedLines = protectedLines - originalLines;
                
                document.getElementById('originalLines').textContent = originalLines;
                document.getElementById('protectedLines').textContent = protectedLines;
                document.getElementById('addedLines').textContent = '+' + addedLines;
                
                // Scroll al resultado
                setTimeout(() => {
                    document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                
            } catch (error) {
                console.error('Error al proteger estrategia:', error);
                alert('‚ùå Error al procesar la estrategia: ' + error.message + '\n\nPor favor verifica que el c√≥digo est√© completo.');
            }
        }
        
        function generateSmartProtection(originalCode) {
            const warnings = [];
            let code = generateProtectedStrategy(originalCode, true);
            
            // Validar que se encontraron √≥rdenes
            const hasOrders = originalCode.match(/\b(buy|sell|sellshort|buytocover)\s*\(/i);
            if (!hasOrders) {
                warnings.push('No se detectaron √≥rdenes de trading (Buy, Sell, etc). Verifica que tu estrategia est√© completa.');
            }
            
            return { code, warnings };
        }
        
        function generateFullProtection(originalCode) {
            const warnings = [];
            let code = generateProtectedStrategy(originalCode, false);
            
            warnings.push('Modo "Todo el C√≥digo": Los c√°lculos tambi√©n est√°n protegidos. Sin licencia, la estrategia no ejecutar√° ning√∫n c√≥digo.');
            
            return { code, warnings };
        }
        
        function generateProtectedStrategy(originalCode, smartMode) {
            // Detectar header
            const hasHeader = originalCode.startsWith('{');
            let header = '';
            let body = originalCode;
            
            if (hasHeader) {
                const headerEnd = originalCode.indexOf('}');
                if (headerEnd !== -1) {
                    header = originalCode.substring(0, headerEnd + 1);
                    body = originalCode.substring(headerEnd + 1).trim();
                    
                    if (!header.includes('AINSIDE') && !header.includes('LICENSE')) {
                        header = header.replace('}', '\n  + PROTECCION DE LICENCIA AINSIDE\n  + Verificaci√≥n HWID por PC\n}');
                    }
                }
            } else {
                header = `{=================================================================
  ESTRATEGIA PROTEGIDA CON AINSIDE LICENSE
  
  Protecci√≥n de licencia por HWID del PC.
  Solo funciona en equipos con licencia activa.
  
  REQUISITOS:
  - AInsideLicenseBridgeCpp.dll instalada
  - Servicio: HWID.exe --service
  - Licencia activa
=================================================================}`;
            }
            
            // Parser mejorado de secciones
            const sections = parseStrategy(body);
            
            // Agregar DebugLicense input
            if (!sections.inputs.toLowerCase().includes('debuglicense')) {
                sections.inputs = addToSection(sections.inputs, 'Inputs', '    DebugLicense(1);', true);
            }
            
            // Agregar IsAllowed variable
            if (!sections.variables.toLowerCase().includes('isallowed')) {
                sections.variables = addToSection(sections.variables, 'Variables', '    IsAllowed(0),', false);
            }
            
            // Construir c√≥digo protegido
            let result = header + '\n\n';
            result += buildLicenseHeader();
            result += sections.inputs + '\n\n';
            result += sections.variables + '\n\n';
            result += buildLicenseCheck();
            
            if (smartMode) {
                // Modo inteligente: separar c√°lculos de √≥rdenes
                const separated = separateCalculationsAndOrders(sections.logic);
                
                if (separated.calculations.trim()) {
                    result += `// ================================================\n`;
                    result += `// CALCULOS (siempre se ejecutan)\n`;
                    result += `// ================================================\n`;
                    result += separated.calculations + '\n\n';
                }
                
                if (separated.orders.trim()) {
                    result += `// ================================================\n`;
                    result += `// ORDENES (solo con licencia)\n`;
                    result += `// ================================================\n`;
                    result += `if IsAllowed = 1 then begin\n\n`;
                    result += indentCode(separated.orders);
                    result += `\n\nend; // Fin protecci√≥n\n`;
                }
            } else {
                // Modo completo: todo envuelto
                result += `// ================================================\n`;
                result += `// LOGICA DE TRADING (solo con licencia)\n`;
                result += `// ================================================\n`;
                result += `if IsAllowed = 1 then begin\n\n`;
                result += indentCode(sections.logic);
                result += `\n\nend; // Fin protecci√≥n\n`;
            }
            
            return result;
        }
        
        function parseStrategy(body) {
            const lines = body.split('\n');
            let section = 'before';
            let inputs = '';
            let variables = '';
            let logic = '';
            
            for (let line of lines) {
                const trimmed = line.trim().toLowerCase();
                
                // Detectar inicio de Inputs
                if (trimmed.startsWith('inputs:') || trimmed.startsWith('input:')) {
                    if (section !== 'inputs') { // Evitar duplicados
                        section = 'inputs';
                        inputs += line + '\n';
                    }
                    continue;
                }
                
                // Detectar inicio de Variables/Vars
                if (trimmed.startsWith('variables:') || trimmed.startsWith('vars:') || trimmed.startsWith('variable:')) {
                    if (section !== 'variables') { // Evitar duplicados
                        section = 'variables';
                        variables += line + '\n';
                    }
                    continue;
                }
                
                // Continuar en la secci√≥n actual
                if (section === 'inputs') {
                    // Detectar fin de inputs
                    if (trimmed && !trimmed.endsWith(',') && !trimmed.endsWith(';') && !trimmed.startsWith('{') && !trimmed.startsWith('//')) {
                        if (trimmed.includes(' = ') || trimmed.startsWith('if ') || trimmed.startsWith('for ') || trimmed.startsWith('while ')) {
                            section = 'logic';
                            logic += line + '\n';
                            continue;
                        }
                    }
                    inputs += line + '\n';
                }
                else if (section === 'variables') {
                    // Detectar fin de variables
                    if (trimmed && !trimmed.endsWith(',') && !trimmed.endsWith(';') && !trimmed.startsWith('{') && !trimmed.startsWith('//')) {
                        if (trimmed.includes(' = ') || trimmed.startsWith('if ') || trimmed.startsWith('for ') || trimmed.startsWith('while ')) {
                            section = 'logic';
                            logic += line + '\n';
                            continue;
                        }
                    }
                    variables += line + '\n';
                }
                else if (section === 'logic') {
                    logic += line + '\n';
                }
                else {
                    // Antes de cualquier secci√≥n, ignorar
                }
            }
            
            // Asegurar que no haya duplicados
            inputs = inputs.trim();
            variables = variables.trim();
            logic = logic.trim();
            
            // Si no hay inputs, crear vac√≠o
            if (!inputs) {
                inputs = 'Inputs:\n    // Sin inputs adicionales\n    DebugLicense(1);';
            }
            
            // Si no hay variables, crear solo con IsAllowed
            if (!variables) {
                variables = 'Vars:\n    IsAllowed(0);';
            }
            
            return { inputs, variables, logic };
        }
        
        function separateCalculationsAndOrders(logic) {
            const lines = logic.split('\n');
            let calculations = '';
            let orders = '';
            let inOrderBlock = false;
            let blockLevel = 0;
            
            for (let line of lines) {
                const trimmed = line.trim().toLowerCase();
                const isOrder = /\b(buy|sell|sellshort|buytocover)\s*\(/.test(trimmed);
                const isBegin = trimmed === 'begin';
                const isEnd = trimmed.startsWith('end');
                
                if (isBegin) blockLevel++;
                if (isEnd) blockLevel--;
                
                if (isOrder) {
                    inOrderBlock = true;
                }
                
                if (inOrderBlock) {
                    orders += line + '\n';
                    if (blockLevel === 0 && trimmed.endsWith(';')) {
                        inOrderBlock = false;
                    }
                } else {
                    calculations += line + '\n';
                }
            }
            
            return { calculations: calculations.trim(), orders: orders.trim() };
        }
        
        function addToSection(section, sectionName, newContent, isLast) {
            if (!section || section.trim() === '') {
                return `${sectionName}:\n${newContent}`;
            }
            
            // Verificar si ya contiene el contenido
            if (section.toLowerCase().includes('debuglicense') || section.toLowerCase().includes('isallowed')) {
                return section; // Ya tiene, no agregar
            }
            
            const lines = section.split('\n');
            
            if (isLast) {
                // Agregar al final (para DebugLicense en Inputs)
                const lastLineIndex = lines.length - 1;
                const lastLine = lines[lastLineIndex].trim();
                
                if (lastLine.endsWith(';')) {
                    // Reemplazar ; por , y agregar el nuevo input
                    lines[lastLineIndex] = lines[lastLineIndex].replace(/;[\s]*$/, ',');
                    lines.push('    ' + newContent.trim().replace(/^[ \t]+/, ''));
                } else if (lastLine.endsWith(',')) {
                    lines.push('    ' + newContent.trim().replace(/^[ \t]+/, ''));
                } else {
                    lines.push(',');
                    lines.push('    ' + newContent.trim().replace(/^[ \t]+/, ''));
                }
            } else {
                // Agregar al principio (para IsAllowed en Variables)
                let insertIndex = -1;
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].toLowerCase().includes(sectionName.toLowerCase() + ':')) {
                        insertIndex = i + 1;
                        break;
                    }
                }
                
                if (insertIndex > -1) {
                    lines.splice(insertIndex, 0, '    ' + newContent.trim().replace(/^[ \t]+/, ''));
                }
            }
            
            return lines.join('\n');
        }
        
        function buildLicenseHeader() {
            return `// ================================================
// PROTECCION DE LICENCIA AINSIDE
// ================================================
DefineDLLFunc: "AInsideLicenseBridgeCpp.dll", int, "AInside_IsAllowed";

`;
        }
        
        function buildLicenseCheck() {
            return `// ================================================
// VERIFICACION DE LICENCIA
// ================================================
IsAllowed = AInside_IsAllowed();

if DebugLicense = 1 then begin
    Print("=== AInside License ===");
    if IsAllowed = 1 then
        Print("Estado: ACTIVA")
    else
        Print("Estado: BLOQUEADA");
end;

// Cerrar posiciones si no hay licencia
if IsAllowed = 0 then begin
    if MarketPosition = 1 then
        Sell("Lic_Exit_L") this bar at close;
    if MarketPosition = -1 then
        BuyToCover("Lic_Exit_S") this bar at close;
end;

`;
        }
        
        function indentCode(code) {
            return code.split('\n').map(line => '    ' + line).join('\n');
        }
        
        function copyToClipboard(event) {
            const output = document.getElementById('outputStrategy').textContent;
            const btn = event.target;
            const originalText = btn.textContent;
            
            navigator.clipboard.writeText(output).then(() => {
                btn.textContent = '‚úÖ ¬°COPIADO!';
                btn.style.background = '#28a745';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                // Fallback para navegadores sin clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = output;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    btn.textContent = '‚úÖ ¬°COPIADO!';
                    btn.style.background = '#28a745';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                } catch (err) {
                    alert('‚ö†Ô∏è Error al copiar. Por favor copia manualmente.');
                }
                document.body.removeChild(textArea);
            });
        }
    </script>
</body>
</html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AInside License Protector - TradeStation Strategies</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a7b 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #3dd5af 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.3em;
            color: #1e3a5f;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3dd5af;
        }
        
        textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #3dd5af;
        }
        
        .button-container {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            background: linear-gradient(135deg, #1e3a5f 0%, #3dd5af 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(61, 213, 175, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-copy {
            background: #28a745;
            padding: 10px 30px;
            font-size: 0.95em;
            margin-top: 10px;
        }
        
        .btn-copy:hover {
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        }
        
        .output {
            background: #f8f9fa;
            border: 2px solid #3dd5af;
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .feature-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3dd5af;
        }
        
        .feature-card h3 {
            color: #1e3a5f;
            margin-bottom: 10px;
        }
        
        .feature-card p {
            color: #666;
            line-height: 1.6;
        }
        
        .hidden {
            display: none;
        }
        
        pre {
            margin: 0;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #1e3a5f;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è AInside License Protector</h1>
            <p>Protege tus estrategias de TradeStation con licencias HWID</p>
        </div>
        
        <div class="content">
            <div class="alert alert-info">
                <strong>üìã Instrucciones:</strong> Pega tu estrategia de TradeStation en el campo de abajo y presiona "Proteger Estrategia". 
                El c√≥digo de licencia se agregar√° autom√°ticamente al inicio y envolver√° toda tu l√≥gica.
            </div>
            
            <div class="features">
                <div class="feature-card">
                    <h3>‚úÖ Verificaci√≥n HWID</h3>
                    <p>Valida la licencia en cada barra usando el hardware ID √∫nico del PC</p>
                </div>
                <div class="feature-card">
                    <h3>üîí Cierre Autom√°tico</h3>
                    <p>Cierra posiciones inmediatamente si la licencia no es v√°lida</p>
                </div>
                <div class="feature-card">
                    <h3>üìä Debug Integrado</h3>
                    <p>Logs opcionales para ver el estado de la licencia en tiempo real</p>
                </div>
                <div class="feature-card">
                    <h3>üöÄ Plug & Play</h3>
                    <p>Tu estrategia mantiene toda su l√≥gica original intacta</p>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">1Ô∏è‚É£ Estrategia Original (sin protecci√≥n)</div>
                <textarea id="inputStrategy" placeholder="Pega aqu√≠ tu estrategia de TradeStation...

Ejemplo:

Inputs:
    FastLength(9),
    SlowLength(18);

Variables:
    FastMA(0),
    SlowMA(0);

FastMA = Average(Close, FastLength);
SlowMA = Average(Close, SlowLength);

if FastMA crosses above SlowMA then
    Buy(&quot;Long&quot;) next bar at market;
"></textarea>
            </div>
            
            <div class="button-container">
                <button class="btn" onclick="protectStrategy()">
                    üõ°Ô∏è PROTEGER CON LICENCIA AINSIDE
                </button>
            </div>
            
            <div class="section hidden" id="outputSection">
                <div class="section-title">2Ô∏è‚É£ Estrategia Protegida (lista para usar)</div>
                
                <div class="alert alert-success">
                    <strong>‚úÖ ¬°Estrategia protegida exitosamente!</strong> 
                    Copia el c√≥digo de abajo e imp√≥rtalo en TradeStation.
                </div>
                
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="originalLines">0</div>
                        <div class="stat-label">L√≠neas originales</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="protectedLines">0</div>
                        <div class="stat-label">L√≠neas protegidas</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="addedLines">0</div>
                        <div class="stat-label">L√≠neas agregadas</div>
                    </div>
                </div>
                
                <div class="output" id="outputStrategy"></div>
                
                <div class="button-container">
                    <button class="btn btn-copy" onclick="copyToClipboard(event)">
                        üìã COPIAR AL PORTAPAPELES
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function protectStrategy() {
            const input = document.getElementById('inputStrategy').value.trim();
            
            if (!input) {
                alert('‚ö†Ô∏è Por favor pega tu estrategia primero');
                return;
            }
            
            // Detectar si ya tiene la protecci√≥n
            if (input.includes('DefineDLLFunc: "AInsideLicenseBridgeCpp.dll"')) {
                if (!confirm('‚ö†Ô∏è Esta estrategia ya parece tener protecci√≥n de licencia. ¬øDeseas reemplazarla?')) {
                    return;
                }
            }
            
            // Construir estrategia protegida
            const protectedStrategy = generateProtectedStrategy(input);
            
            // Mostrar resultado
            document.getElementById('outputStrategy').textContent = protectedStrategy;
            document.getElementById('outputSection').classList.remove('hidden');
            
            // Calcular estad√≠sticas
            const originalLines = input.split('\n').length;
            const protectedLines = protectedStrategy.split('\n').length;
            const addedLines = protectedLines - originalLines;
            
            document.getElementById('originalLines').textContent = originalLines;
            document.getElementById('protectedLines').textContent = protectedLines;
            document.getElementById('addedLines').textContent = '+' + addedLines;
            
            // Scroll al resultado
            document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        function generateProtectedStrategy(originalCode) {
            // Detectar si tiene comentario de encabezado
            const hasHeader = originalCode.startsWith('{');
            
            let header = '';
            let body = originalCode;
            
            if (hasHeader) {
                // Extraer header existente
                const headerEnd = originalCode.indexOf('}');
                if (headerEnd !== -1) {
                    header = originalCode.substring(0, headerEnd + 1);
                    body = originalCode.substring(headerEnd + 1).trim();
                    
                    // Actualizar header para incluir menci√≥n de licencia
                    if (!header.includes('AINSIDE') && !header.includes('LICENSE')) {
                        header = header.replace('}', '\n  + PROTECCION DE LICENCIA AINSIDE\n  + Verificaci√≥n HWID en cada barra\n}');
                    }
                }
            } else {
                // Crear header nuevo
                header = `{=================================================================
  ESTRATEGIA PROTEGIDA CON AINSIDE LICENSE
  
  Esta estrategia incluye protecci√≥n de licencia por HWID.
  Solo funcionar√° en PCs con licencia activa.
  
  REQUISITOS:
  - DLL AInsideLicenseBridgeCpp.dll instalada
  - Servicio local corriendo: HWID.exe --service
  - Licencia activa en el sistema
=================================================================}`;
            }
            
            // Separar secciones
            const lines = body.split('\n');
            let inputsSection = '';
            let varsSection = '';
            let beforeLogic = '';
            let tradingLogic = '';
            let inInputs = false;
            let inVars = false;
            let logicStarted = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmed = line.trim();
                
                // Detectar inicio de Inputs
                if (trimmed.match(/^Inputs?:/i)) {
                    inInputs = true;
                    inputsSection += line + '\n';
                    continue;
                }
                
                // Detectar fin de Inputs (cuando empieza Variables o c√≥digo)
                if (inInputs && (trimmed.match(/^Variables?:/i) || (trimmed && !trimmed.endsWith(',') && !trimmed.endsWith(';') && trimmed.match(/^[A-Z]/)))) {
                    inInputs = false;
                }
                
                // Detectar inicio de Variables
                if (trimmed.match(/^Variables?:/i)) {
                    inVars = true;
                    varsSection += line + '\n';
                    continue;
                }
                
                // Detectar fin de Variables (cuando empieza el c√≥digo de l√≥gica)
                if (inVars && trimmed && !trimmed.endsWith(',') && !trimmed.endsWith(';') && (trimmed.match(/^If /i) || trimmed.match(/^[A-Z][a-zA-Z]+ =/))) {
                    inVars = false;
                    logicStarted = true;
                }
                
                // Agregar l√≠nea a la secci√≥n correspondiente
                if (inInputs) {
                    inputsSection += line + '\n';
                } else if (inVars) {
                    varsSection += line + '\n';
                } else if (logicStarted) {
                    tradingLogic += line + '\n';
                } else {
                    beforeLogic += line + '\n';
                }
            }
            
            // Agregar input de Debug si no existe
            if (inputsSection && !inputsSection.toLowerCase().includes('debuglicense')) {
                inputsSection = inputsSection.trim();
                const lastSemicolon = inputsSection.lastIndexOf(';');
                if (lastSemicolon !== -1) {
                    const beforeSemi = inputsSection.substring(0, lastSemicolon).replace(/,\s*$/, '');
                    inputsSection = beforeSemi + ',\n    \n    { === Debug Licencia === }\n    DebugLicense(1);';
                }
            }
            
            // Agregar variable IsAllowed si no existe
            if (varsSection && !varsSection.toLowerCase().includes('isallowed')) {
                const varsMatch = varsSection.match(/(Variables?:\s*)/i);
                if (varsMatch) {
                    const insertPos = varsMatch.index + varsMatch[0].length;
                    varsSection = varsSection.substring(0, insertPos) + 
                        '\n    { === Licencia === }\n    IsAllowed(0),\n    ' +
                        varsSection.substring(insertPos).trim();
                }
            } else if (!varsSection) {
                varsSection = `Variables:\n    { === Licencia === }\n    IsAllowed(0);`;
            }
            
            // Detectar c√≥digo que NO debe envolverse (inicializaciones, c√°lculos, etc)
            const logicLines = tradingLogic.split('\n');
            let unwrappedCode = '';
            let wrappedCode = '';
            
            for (let line of logicLines) {
                const trimmed = line.trim().toLowerCase();
                
                // C√≥digo que NO se envuelve (se ejecuta siempre)
                const isUnwrapped = 
                    trimmed.startsWith('//') ||  // Comentarios
                    trimmed.match(/^if date <>/i) ||  // Reinicio diario
                    trimmed.match(/^[a-z_][a-z0-9_]* = /i) ||  // Asignaciones de variables
                    trimmed.match(/^value\d+ = /i) ||  // Value assignments
                    trimmed.includes('print(') && !trimmed.includes('buy') && !trimmed.includes('sell') ||
                    trimmed === '' ||  // L√≠neas vac√≠as
                    trimmed.match(/^end;?/i);  // Ends (manejados por contexto)
                
                // C√≥digo que S√ç se envuelve (√≥rdenes de trading)
                const isOrder = 
                    trimmed.includes('buy(') ||
                    trimmed.includes('sell(') ||
                    trimmed.includes('sellshort(') ||
                    trimmed.includes('buytocover(');
                
                if (isOrder || (wrappedCode && !isUnwrapped)) {
                    wrappedCode += line + '\n';
                } else if (!wrappedCode || isUnwrapped) {
                    unwrappedCode += line + '\n';
                }
            }
            
            // Si no detect√≥ √≥rdenes espec√≠ficas, envolver todo (fallback seguro)
            if (!wrappedCode.trim()) {
                wrappedCode = tradingLogic;
                unwrappedCode = '';
            }
            
            // Construir c√≥digo protegido
            let protectedCode = header + '\n\n';
            
            // Declaraci√≥n DLL
            protectedCode += `// ================================================\n`;
            protectedCode += `// PROTECCION DE LICENCIA AINSIDE\n`;
            protectedCode += `// ================================================\n`;
            protectedCode += `DefineDLLFunc: "AInsideLicenseBridgeCpp.dll", int, "AInside_IsAllowed";\n\n`;
            
            // Inputs
            if (inputsSection.trim()) {
                protectedCode += inputsSection.trim() + '\n\n';
            }
            
            // Variables
            if (varsSection.trim()) {
                protectedCode += varsSection.trim() + '\n\n';
            }
            
            // Verificaci√≥n de licencia
            protectedCode += `// ================================================\n`;
            protectedCode += `// VERIFICACION DE LICENCIA\n`;
            protectedCode += `// ================================================\n`;
            protectedCode += `IsAllowed = AInside_IsAllowed();\n\n`;
            protectedCode += `if DebugLicense = 1 then begin\n`;
            protectedCode += `    Print("=== AInside License Status ===");\n`;
            protectedCode += `    if IsAllowed = 1 then\n`;
            protectedCode += `        Print("Licencia: ACTIVA")\n`;
            protectedCode += `    else\n`;
            protectedCode += `        Print("Licencia: BLOQUEADA");\n`;
            protectedCode += `end;\n\n`;
            protectedCode += `// Cerrar posiciones si no hay licencia\n`;
            protectedCode += `if IsAllowed = 0 then begin\n`;
            protectedCode += `    if MarketPosition = 1 then\n`;
            protectedCode += `        Sell("Lic_Exit_L") this bar at close;\n`;
            protectedCode += `    if MarketPosition = -1 then\n`;
            protectedCode += `        BuyToCover("Lic_Exit_S") this bar at close;\n`;
            protectedCode += `end;\n\n`;
            
            // C√≥digo que se ejecuta SIEMPRE (c√°lculos, inicializaciones)
            if (unwrappedCode.trim()) {
                protectedCode += `// ================================================\n`;
                protectedCode += `// CALCULOS E INICIALIZACIONES (siempre se ejecutan)\n`;
                protectedCode += `// ================================================\n`;
                protectedCode += unwrappedCode.trim() + '\n\n';
            }
            
            // C√≥digo de trading PROTEGIDO (√≥rdenes)
            if (wrappedCode.trim()) {
                protectedCode += `// ================================================\n`;
                protectedCode += `// ORDENES DE TRADING (solo con licencia valida)\n`;
                protectedCode += `// ================================================\n`;
                protectedCode += `if IsAllowed = 1 then begin\n\n`;
                
                // Indentar c√≥digo de √≥rdenes
                const indentedCode = wrappedCode.trim().split('\n').map(line => '    ' + line).join('\n');
                protectedCode += indentedCode;
                
                protectedCode += `\n\nend; // Fin del bloque if IsAllowed = 1\n`;
            }
            
            return protectedCode;
        }
        
        function copyToClipboard(event) {
            const output = document.getElementById('outputStrategy').textContent;
            const btn = event.target;
            const originalText = btn.textContent;
            
            navigator.clipboard.writeText(output).then(() => {
                btn.textContent = '‚úÖ ¬°COPIADO!';
                btn.style.background = '#28a745';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                alert('‚ö†Ô∏è Error al copiar: ' + err);
                console.error('Error al copiar:', err);
            });
        }
    </script>
</body>
</html>
