<!DOCTYPE html>
<html>
<head>
    <title>Debug Environment</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #00ff00; }
        .good { color: #00ff00; }
        .bad { color: #ff0000; }
        .info { color: #ffff00; }
        pre { background: #000; padding: 10px; border: 1px solid #00ff00; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Debug: Verificando configuración de Supabase</h1>
    <div id="output">Iniciando tests...</div>
    
    <script>
        const output = document.getElementById('output');
        output.innerHTML = '';
        
        function log(msg, type = 'good') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = msg;
            output.appendChild(div);
        }
        
        log('=== INICIANDO DEBUG ===', 'info');
        log('', 'info');
        
        // Probar keys directamente con fetch (sin necesidad de librería)
        async function testKey(keyName, keyValue) {
            log(`Probando ${keyName}...`, 'info');
            log(`Últimos 10 caracteres: ...${keyValue.slice(-10)}`, 'info');
            
            try {
                const supabaseUrl = 'https://odlxhgatqyodxdessxts.supabase.co';
                
                // Test simple: llamar al endpoint de auth health
                const response = await fetch(`${supabaseUrl}/auth/v1/health`, {
                    method: 'GET',
                    headers: {
                        'apikey': keyValue,
                        'Authorization': `Bearer ${keyValue}`
                    }
                });
                
                if (response.ok) {
                    log(`✅ ${keyName}: FUNCIONA! (status ${response.status})`, 'good');
                    return true;
                } else {
                    log(`❌ ${keyName}: Error HTTP ${response.status}`, 'bad');
                    return false;
                }
            } catch (err) {
                log(`❌ ${keyName}: Exception - ${err.message}`, 'bad');
                return false;
            }
        }
        
        // Key vieja (invalidada después de JWT rotation)
        const oldKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kbHhoZ2F0cXlvZHhkZXNzeHRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY5ODc1MTUsImV4cCI6MjA1MjU2MzUxNX0.4HJL3MOuiVLW96PpMpxJlIeREIZY2a6j-BHwLnbw2Y4';
        
        // Key nueva (la correcta después de JWT rotation)
        const newKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kbHhoZ2F0cXlvZHhkZXNzeHRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NDgzNTAsImV4cCI6MjA4NTEwODM1MH0.Qjpq0pKl_NEGEkHFaUzHv3hWh2rgeke_DKujdcB-xLA';
        
        (async () => {
            log('', 'info');
            log('TEST 1: Key VIEJA (termina en ...nbw2Y4)', 'info');
            const oldWorks = await testKey('KEY VIEJA', oldKey);
            
            log('', 'info');
            log('TEST 2: Key NUEVA (termina en ...dcB-xLA)', 'info');
            const newWorks = await testKey('KEY NUEVA', newKey);
            
            log('', 'info');
            log('=== CONCLUSIÓN ===', 'info');
            
            if (oldWorks && !newWorks) {
                log('❌ PROBLEMA CRÍTICO: Supabase acepta la KEY VIEJA pero no la NUEVA', 'bad');
                log('Esto significa que el JWT NO fue rotado correctamente en Supabase', 'bad');
                log('', 'info');
                log('SOLUCIÓN: Ve a Supabase Dashboard > Settings > API', 'info');
                log('y verifica que generaste una nueva clave JWT', 'info');
            } else if (!oldWorks && newWorks) {
                log('✅ PERFECTO: Key vieja invalidada, key nueva funciona', 'good');
                log('JWT rotation funcionó correctamente', 'good');
                log('', 'info');
                log('SIGUIENTE PASO: Verificar que Vercel use la key nueva', 'info');
            } else if (oldWorks && newWorks) {
                log('⚠️ ADVERTENCIA: Ambas keys funcionan', 'info');
                log('El JWT NO fue rotado en Supabase', 'info');
                log('Las keys viejas siguen siendo válidas (riesgo de seguridad)', 'bad');
            } else {
                log('❌ GRAVE: Ninguna key funciona', 'bad');
                log('Puede ser un problema de red o CORS', 'bad');
            }
            
            log('', 'info');
            log('=== DEBUG COMPLETO ===', 'info');
        })();
    </script>
</body>
</html>
